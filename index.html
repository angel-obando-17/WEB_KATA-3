<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero de avance – Proyecto Bioetanol (Sync JSONBin)</title>
  <style>
    :root{
      --bg:#ffffff; --card:#f8f9fa; --ink:#1a1a1a; --muted:#6c757d; --primary:#0066cc; --accent:#00b894;
      --warning:#ffd166; --danger:#ff6b6b; --ok:#4ade80; --bar:#e9ecef; --shadow:0 2px 8px rgba(0,0,0,.08);
      --radius:12px;
    }
    body.dark-theme{
      --bg:#1a1a1a; --card:#2d3748; --ink:#ffffff; --muted:#a0aec0; --bar:#4a5568; --shadow:0 2px 8px rgba(0,0,0,.3);
    }
    body.dark-theme .card{background:var(--card);color:var(--ink)}
    body.dark-theme .summary-item{background:var(--card);border-color:#4a5568}
    body.dark-theme .table-card table{background:var(--card)}
    body.dark-theme thead th{background:var(--card);border-color:#4a5568}
    body.dark-theme tbody tr:nth-child(even){background:var(--card)}
    body.dark-theme tbody tr:nth-child(odd){background:#374151}
    body.dark-theme tbody tr:hover{background:#4a5568}
    body.dark-theme .chart-container{background:var(--card)}
    body.dark-theme .advance-delay-info{background:var(--card);border-color:#4a5568}
    body.dark-theme .pill{background:#4a5568;border-color:#718096}
    body.dark-theme input[type="number"]{background:var(--card);border-color:#4a5568;color:var(--ink)}
    body.dark-theme select{background:var(--card);border-color:#4a5568;color:var(--ink)}
    body.dark-theme input[type="date"]{background:var(--card);border-color:#4a5568;color:var(--ink)}
    body.dark-theme button{background:var(--card);border-color:#4a5568;color:var(--ink)}
    body.dark-theme button:hover{background:#4a5568;border-color:var(--primary)}
    body.dark-theme .secondary{background:#4a5568}
    *{box-sizing:border-box}
    html,body{margin:0;background:#ffffff;color:var(--ink);font-family:"Times New Roman", Times, serif;}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px 64px}
    header{display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #e9ecef}
    h1{font-weight:700;letter-spacing:.3px;margin:0;font-size:clamp(24px,3vw,32px);color:#1a1a1a}
    .tag{color:var(--primary);font-weight:700}
    .card{background:#ffffff;border:1px solid #dee2e6;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .grid{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:880px){.grid{grid-template-columns:1.2fr .8fr}}
    .progress-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .summary-item{background:#f8f9fa;border:1px solid #dee2e6;padding:16px;border-radius:10px}
    .summary-head{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:13px;margin-bottom:10px}
    .bar{height:14px;background:var(--bar);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--accent));transition:width .5s ease}
    .pct{font-weight:700;color:var(--ink)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:var(--muted)}
    .pill{padding:6px 12px;border-radius:999px;background:#e9ecef;border:1px solid #dee2e6}
    .table-card{margin-top:20px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:10px;border:1px solid #dee2e6}
    th,td{padding:12px 10px;vertical-align:top}
    thead th{position:sticky;top:0;background:#f8f9fa;text-align:left;color:#495057;font-size:13px;font-weight:700;border-bottom:2px solid #dee2e6}
    tbody tr:nth-child(even){background:#ffffff}
    tbody tr:nth-child(odd){background:#f8f9fa}
    tbody tr:hover{background:#e9ecef}
    .w-week{white-space:nowrap}
    input[type="number"]{width:80px;background:#ffffff;border:1px solid #ced4da;color:var(--ink);border-radius:6px;padding:6px 8px;font-weight:600}
    input[type="number"]:focus{outline:none;border-color:var(--primary)}
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
    .weight{font-weight:700;color:var(--primary)}
    .row-progress{display:flex;align-items:center;gap:8px}
    .row-progress .mini{height:10px;background:#e9ecef;border-radius:8px;flex:1}
    .row-progress .mini>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--primary));transition:width .5s ease}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    button{cursor:pointer;padding:10px 16px;border-radius:8px;border:1px solid #dee2e6;background:#ffffff;color:var(--ink);font-weight:600;box-shadow:var(--shadow);transition:all .2s}
    button:hover{background:#f8f9fa;border-color:var(--primary);color:var(--primary)}
    button.secondary{background:#f8f9fa}
    .note{color:var(--muted);font-size:13px;line-height:1.5}
    .footer{margin-top:32px;color:var(--muted);font-size:12px;text-align:center;padding-top:16px;border-top:1px solid #e9ecef}
    .ring{display:grid;place-items:center;aspect-ratio:1;border-radius:50%;
      background:radial-gradient(closest-side,#ffffff 78%,transparent 80% 100%),conic-gradient(var(--primary) var(--pct,0%),#e9ecef 0);
      width:120px;border:2px solid #dee2e6}
    .ring b{font-size:20px;color:var(--ink)}
    .side{display:grid;gap:16px}
    .side .card{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
    .chart-container{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:10px;border:1px solid #dee2e6}
    .chart-title{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--ink)}
    canvas{max-width:100%;height:auto}
    .advance-delay-info{background:#ffffff;border:1px solid #dee2e6;border-radius:6px;padding:8px;margin-bottom:12px;font-size:14px}
    .advance-delay-info strong{color:var(--ink)}
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:9999;max-width:360px;font-size:13px}
    .toast .t{background:#ffffff;border:1px solid #dee2e6;border-left:6px solid var(--primary);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow)}
    .t.ok{border-left-color:var(--ok)} .t.warn{border-left-color:var(--warning)} .t.err{border-left-color:var(--danger)}
    .right-tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .switch input{accent-color:var(--primary)}
    .theme-toggle{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .theme-toggle button{padding:6px 12px;border:1px solid #dee2e6;background:#ffffff;color:var(--ink);border-radius:6px;cursor:pointer}
    .theme-toggle button:hover{background:#f8f9fa}
    .tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid #dee2e6}
    .tab-btn{padding:10px 20px;border:1px solid #dee2e6;border-bottom:none;background:#f8f9fa;color:var(--ink);cursor:pointer;border-radius:6px 6px 0 0;font-weight:600}
    .tab-btn.active{background:#ffffff;border-bottom:1px solid #ffffff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .week-summary{margin-top:20px}
    .week-card{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:16px;margin-bottom:12px}
    .week-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .week-title{font-weight:700;color:var(--ink)}
    .week-status{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600}
    .week-status.current{background:#ffd166;color:#000}
    .week-status.completed{background:#00b894;color:#fff}
    .week-status.pending{background:#6c757d;color:#fff}
    .task-list{list-style:none;padding:0;margin:0}
    .task-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #e9ecef}
    .task-item:last-child{border-bottom:none}
    .task-checkbox{width:16px;height:16px;border:1px solid #ced4da;border-radius:3px;background:#fff}
    .task-checkbox.checked{background:#00b894;border-color:#00b894}
    .task-name{flex:1;font-size:14px}
    .task-objective{color:#6c757d;font-size:12px;margin-left:8px}
    .task-weight{font-weight:600;color:#0066cc}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tablero de avance <span class="tag">Bioetanol</span></h1>
      <div class="right-tools">
        <div class="legend">
          <span class="pill">Ingresa tu <b>avance (%)</b> por actividad</span>
          <span class="pill">Cálculo automático por <b>pesos</b></span>
          <span class="pill">Local + <b>JSONBin</b></span>
        </div>
        <div class="switch">
          <input type="checkbox" id="autosync">
          <label for="autosync"><b>Autosync</b> (JSONBin)</label>
        </div>
        <div class="theme-toggle">
          <button id="themeBtn" title="Cambiar tema">Tema Claro</button>
        </div>
        <button id="pull" title="Traer desde la nube">Sync ↓</button>
        <button id="push" title="Enviar a la nube">Sync ↑</button>
      </div>
    </header>
    <!-- Configuración de fechas -->
    <section class="card" style="margin-bottom:20px">
      <h3 style="margin-top:0">⏱️ Configuración del Timeline</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:12px">
        <div>
          <label style="display:block;font-size:13px;color:var(--muted);margin-bottom:6px"><b>Fecha de inicio (Semana 1)</b></label>
          <input type="date" id="startDate" style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:6px;font-family:'Times New Roman',serif">
        </div>
        <div>
          <label style="display:block;font-size:13px;color:var(--muted);margin-bottom:6px"><b>Semana actual</b></label>
          <select id="currentWeek" style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:6px;font-weight:600;font-family:'Times New Roman',serif;background:#ffffff">
            <option value="0">No iniciado</option>
            <option value="1">Semana 1</option><option value="2">Semana 2</option><option value="3">Semana 3</option>
            <option value="4">Semana 4</option><option value="5">Semana 5</option><option value="6">Semana 6</option>
            <option value="7">Semana 7</option><option value="8">Semana 8</option><option value="9">Semana 9</option>
            <option value="10">Semana 10</option><option value="11">Semana 11</option>
          </select>
        </div>
        <div>
          <label style="display:block;font-size:13px;color:var(--muted);margin-bottom:6px"><b>Fecha actual</b></label>
          <input type="date" id="currentDate" style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:6px;font-family:'Times New Roman',serif">
        </div>
      </div>
      <div id="weekDates" style="font-size:12px;color:var(--muted);line-height:1.8"></div>
    </section>
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="planning">Planificación</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div class="grid">
        <section class="card">
          <h2 style="margin-top:0">Resumen de progreso</h2>
          <div class="progress-summary" id="summary"></div>
          <div class="tools">
            <button id="save">Guardar local</button>
            <button id="reset">Reiniciar avances</button>
            <button id="export">Exportar datos</button>
            <button id="print" class="secondary">Imprimir / PDF</button>
          </div>
          <p class="note">Consejo: escribe únicamente números entre 0 y 100 en la columna <b>Avance (%)</b>. El tablero calcula el avance de cada objetivo y del proyecto con base en los pesos definidos.</p>
        </section>
        <aside class="side">
          <div class="card" id="overallCard">
            <div class="ring" id="overallRing" style="--pct:0%"><b id="overallPct">0%</b></div>
            <div>
              <h3 style="margin:.2rem 0 6px">Avance total del proyecto</h3>
              <div class="bar"><span id="overallBar" style="width:0%"></span></div>
              <p class="note" style="margin:.6rem 0 0">Pondera el avance de cada objetivo por su peso en el proyecto.</p>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Pesos de los objetivos</h3>
            <ul style="margin:0;padding-left:18px;line-height:1.6">
              <li><b>Objetivo 1:</b> 20%</li>
              <li><b>Objetivo 2:</b> 30%</li>
              <li><b>Objetivo 3:</b> 30%</li>
              <li><b>Objetivo 4:</b> 20%</li>
            </ul>
          </div>
        </aside>
      </div>
    </div>

    <!-- Planning Tab -->
    <div id="planning" class="tab-content">
      <div id="weekSummary"></div>
      <div class="card" style="margin-top:20px">
        <h3>Configuración de Objetivos y Actividades</h3>
        <p>Edita los nombres, pesos y actividades de cada objetivo. Los cambios se guardan automáticamente.</p>
        <div id="configContainer"></div>
        <button id="addObjective" style="margin-top:16px">Agregar Objetivo</button>
      </div>
    </div>
    <!-- Curva S -->
    <section class="card chart-container">
      <h3 class="chart-title">Curva S del Proyecto</h3>
      <div class="advance-delay-info">
        <strong>Estado del proyecto:</strong> <span id="advanceDelayText">Selecciona una semana actual para ver el avance/retraso</span>
      </div>
      <canvas id="curvaS" width="800" height="300"></canvas>
      <p class="note" style="margin-top:12px">La curva S muestra el avance acumulado planificado vs. el avance real del proyecto a lo largo de las 11 semanas. El cálculo de avance/retraso se basa en la comparación del progreso real vs. planificado hasta la semana actual.</p>
    </section>
    <!-- Tablas -->
    <section class="table-card card" id="o1">
      <h3 style="margin-top:0">Tabla 1. Actividades Objetivo 1.</h3>
      <p><b>Objetivo 1.</b> Gestionar un proyecto para la obtención de bioetanol a partir de carbohidratos presentes en <i>C. vulgaris</i> utilizando una solución acidificada de clorito de sodio.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Actividad</th><th>Descripción</th><th>Semana</th><th>Peso (%)</th><th>Avance (%)</th><th>Progreso</th>
            </tr>
          </thead>
          <tbody id="tbody-o1"></tbody>
        </table>
      </div>
    </section>
    <section class="table-card card" id="o2">
      <h3 style="margin-top:0">Tabla 2. Actividades Objetivo 2.</h3>
      <p><b>Objetivo 2.</b> Determinar los requerimientos másicos y energéticos del proceso de obtención de bioetanol.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Actividad</th><th>Descripción</th><th>Semana</th><th>Peso (%)</th><th>Avance (%)</th><th>Progreso</th>
            </tr>
          </thead>
          <tbody id="tbody-o2"></tbody>
        </table>
      </div>
    </section>
    <section class="table-card card" id="o3">
      <h3 style="margin-top:0">Tabla 3. Actividades Objetivo 3.</h3>
      <p><b>Objetivo 3.</b> Desarrollar el proceso de escalado del sistema de producción de bioetanol de acuerdo con los requerimientos del mercado y según los resultados obtenidos en escala de laboratorio.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Actividad</th><th>Descripción</th><th>Semana</th><th>Peso (%)</th><th>Avance (%)</th><th>Progreso</th>
            </tr>
          </thead>
          <tbody id="tbody-o3"></tbody>
        </table>
      </div>
    </section>
    <section class="table-card card" id="o4">
      <h3 style="margin-top:0">Tabla 4. Actividades Objetivo 4.</h3>
      <p><b>Objetivo 4.</b> Establecer la pre-factibilidad financiera del proyecto.</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Actividad</th><th>Descripción</th><th>Semana</th><th>Peso (%)</th><th>Avance (%)</th><th>Progreso</th>
            </tr>
          </thead>
          <tbody id="tbody-o4"></tbody>
        </table>
      </div>
    </section>
    <p class="footer">Hecho con HTML + CSS + JS (sin librerías externas). LocalStorage + Sync JSONBin.</p>
  </div>
  <div class="toast" id="toast"></div>
<script>
// ====== JSONBin config (EN LINEA) ======
const BIN_ID = '68f0705eae596e708f16401f';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const MASTER_KEY = '$2a$10$HufXVv9iC6tHxgSD3dEwQeIMMgUAqVXMUxpSKBlxRqiroROL6OFc2';
const USE_VERSIONING = false;
// ====== Utilidades ======
const key = 'avance-bioetanol-v1';
function loadState(){ try{ return JSON.parse(localStorage.getItem(key))||{} }catch{ return {} } }
function saveStateLocal(state){ localStorage.setItem(key, JSON.stringify(state)); }
const state = loadState();
// ====== Datos del tablero ======
const defaultObjetivos = [
  {id:'o1', nombre:'Objetivo 1', pesoProyecto:20, actividades:[
    {cod:'1.1', semana:'2–5', peso:20, desc:'Actualización de antecedentes, metodología y entregables del proyecto.'},
    {cod:'1.2', semana:'1–3', peso:20, desc:'Elaboración del cronograma final detallado de ejecución del proyecto.'},
    {cod:'1.3', semana:'1–3', peso:15, desc:'Realizar cotizaciones de los reactivos, materiales y equipos requeridos para la corrida experimental.'},
    {cod:'1.4', semana:'1–10', peso:45, desc:'Gestión y seguimiento semanal del cronograma (reuniones, ajustes, control de avance).'}
  ]},
  {id:'o2', nombre:'Objetivo 2', pesoProyecto:30, actividades:[
    {cod:'2.1', semana:'2–3', peso:10, desc:'Elaboración del diagrama PFD (Process Flow Diagram) del proceso completo.'},
    {cod:'2.2', semana:'2–5', peso:30, desc:'Ejecución experimental para obtención de bioetanol.'},
    {cod:'2.3', semana:'5–6', peso:20, desc:'Realizar balance de masa del proceso.'},
    {cod:'2.4', semana:'5–6', peso:20, desc:'Realizar balance de energía del proceso.'},
    {cod:'2.5', semana:'7', peso:20, desc:'Presentación de resultados y entrega de cumplimiento del objetivo 2.'}
  ]},
  {id:'o3', nombre:'Objetivo 3', pesoProyecto:30, actividades:[
    {cod:'3.1', semana:'5–6', peso:20, desc:'Definir la capacidad de producción según la demanda y requerimientos del mercado.'},
    {cod:'3.2', semana:'5–6', peso:10, desc:'Identificar los equipos requeridos según la escala definida.'},
    {cod:'3.3', semana:'7–10', peso:35, desc:'Dimensionar los equipos seleccionados según parámetros de operación.'},
    {cod:'3.4', semana:'7–8', peso:25, desc:'Diseñar el diagrama P&ID del proceso con base en la escala productiva establecida.'},
    {cod:'3.5', semana:'5–6', peso:10, desc:'Realizar el estudio de mercado: análisis de demanda, precios y competidores.'}
  ]},
  {id:'o4', nombre:'Objetivo 4', pesoProyecto:20, actividades:[
    {cod:'4.1', semana:'8–10', peso:15, desc:'Estimar los costos de materias primas, reactivos y equipos.'},
    {cod:'4.2', semana:'8–10', peso:15, desc:'Calcular el costo unitario de producción ($/L de bioetanol).'},
    {cod:'4.3', semana:'8–10', peso:30, desc:'Elaborar flujo de caja proyectado y calcular indicadores financieros (VPN, TIR, periodo de recuperación).'},
    {cod:'4.4', semana:'10', peso:15, desc:'Analizar escenarios financieros (optimista, base, pesimista).'},
    {cod:'4.5', semana:'11', peso:25, desc:'Informe final y presentación conjunta de los objetivos 3 y 4 (resultados técnicos y financieros).'}
  ]}
];
const objetivos = state.objetivos || defaultObjetivos;
function clamp(v){ v = Number(v||0); if(isNaN(v)) v=0; return Math.max(0, Math.min(100, v)); }
function toast(msg, type='ok', ms=2500){
  const box = document.getElementById('toast');
  const el = document.createElement('div');
  el.className = 't ' + (type||''); el.textContent = msg; box.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(4px)';
    setTimeout(()=>box.removeChild(el), 300); }, ms);
}
// ====== Fechas ======
function formatDate(date){ const d=new Date(date),m=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']; return `${d.getDate()} ${m[d.getMonth()]}`;}
function addWeeks(date, w){ const r=new Date(date); r.setDate(r.getDate()+w*7); return r; }
function updateWeekDates(){
  const startInput=document.getElementById('startDate'); const weekDatesDiv=document.getElementById('weekDates');
  if(!startInput.value){ weekDatesDiv.innerHTML='<i>Ingresa una fecha de inicio para ver el timeline de semanas</i>'; return; }
  const startDate=new Date(startInput.value+'T00:00:00');
  let html='<b>Timeline de semanas:</b><br><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-top:8px">';
  for(let i=1;i<=11;i++){ const ws=addWeeks(startDate,i-1), we=addWeeks(startDate,i); we.setDate(we.getDate()-1);
    html+=`<span style="padding:4px 8px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px"><b>S${i}:</b> ${formatDate(ws)} - ${formatDate(we)}</span>`;
  }
  weekDatesDiv.innerHTML=html+'</div>'; state.startDate=startInput.value; markTouched(); drawCurvaS(); saveNowMaybe();
}
function initDatePicker(){
  const startInput=document.getElementById('startDate'); const currentWeekInput=document.getElementById('currentWeek'); const currentDateInput=document.getElementById('currentDate');
  if(state.startDate){ startInput.value=state.startDate; updateWeekDates(); }
  if(state.currentWeek!==undefined){ currentWeekInput.value=state.currentWeek; }
  if(state.currentDate){ currentDateInput.value=state.currentDate; } else { currentDateInput.value=new Date().toISOString().split('T')[0]; state.currentDate=currentDateInput.value; }
  startInput.addEventListener('change', updateWeekDates);
  currentWeekInput.addEventListener('change', ()=>{ state.currentWeek=parseInt(currentWeekInput.value)||0; markTouched(); drawCurvaS(); saveNowMaybe(); });
  currentDateInput.addEventListener('change', ()=>{ state.currentDate=currentDateInput.value; markTouched(); drawCurvaS(); renderWeekPlanning(); saveNowMaybe(); });
}
// ====== Curva S ======
function parseWeeks(str){
  if(typeof str !== 'string') return {start:1, end:1}; // fallback
  if(str.includes('–')){ const p=str.split('–'); return {start:+p[0], end:+p[1]}; }
  const w=+str; return {start:w,end:w};
}
function drawCurvaS(){
  const c=document.getElementById('curvaS'),ctx=c.getContext('2d'),w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
  const ml=60,mr=20,mt=20,mb=60,gw=w-ml-mr,gh=h-mt-mb;
  const planned=[],weeklyPlanned=Array(12).fill(0);
  objetivos.forEach(o=>o.actividades.forEach(a=>{const ws=parseWeeks(a.semana),d=ws.end-ws.start+1,wp=(a.peso*o.pesoProyecto/100)/d; for(let i=ws.start;i<=ws.end;i++) weeklyPlanned[i]+=wp;}));
  planned.push(0); let cum=0; for(let i=1;i<=11;i++){ cum+=weeklyPlanned[i]; planned.push(cum); }
  const actual=[],weeklyActual=Array(12).fill(0);
  objetivos.forEach(o=>o.actividades.forEach(a=>{const ws=parseWeeks(a.semana),p=clamp(state[o.id]?.[a.cod])/100,d=ws.end-ws.start+1,wp=(a.peso*o.pesoProyecto/100*p)/d; for(let i=ws.start;i<=ws.end;i++) weeklyActual[i]+=wp;}));
  actual.push(0); let ac=0; for(let i=1;i<=11;i++){ ac+=weeklyActual[i]; actual.push(ac); }
  ctx.strokeStyle='#dee2e6'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(ml,mt); ctx.lineTo(ml,mt+gh); ctx.lineTo(ml+gw,mt+gh); ctx.stroke();
  ctx.fillStyle='#6c757d'; ctx.font='12px Times New Roman'; ctx.textAlign='right';
  for(let i=0;i<=10;i++){ const y=mt+gh-(i*gh/10),v=i*10; ctx.fillText(v+'%',ml-10,y+4); ctx.strokeStyle='#f8f9fa'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(ml,y); ctx.lineTo(ml+gw,y); ctx.stroke(); }
  ctx.textAlign='center'; ctx.fillStyle='#6c757d';
  const s=state.startDate?new Date(state.startDate+'T00:00:00'):null;
  for(let i=0;i<=11;i++){ const x=ml+(i*gw/11); if(i%2===0||i===11){ ctx.fillText('S'+i,x,mt+gh+20); if(s&&i>0){ const ws=addWeeks(s,i-1); ctx.font='10px Times New Roman'; ctx.fillText(formatDate(ws),x,mt+gh+35); ctx.font='12px Times New Roman'; } } }
  const cw=state.currentWeek||0; if(cw>0&&cw<=11){ const x=ml+(cw*gw/11); ctx.strokeStyle='#ffd166'; ctx.lineWidth=2; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(x,mt); ctx.lineTo(x,mt+gh); ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle='#ffd166'; ctx.font='bold 11px Times New Roman'; ctx.fillText('Semana actual',x,mt-5); ctx.font='12px Times New Roman'; }
  ctx.strokeStyle='#0066cc'; ctx.lineWidth=2; ctx.setLineDash([5,5]); ctx.beginPath();
  for(let i=0;i<=11;i++){ const x=ml+(i*gw/11),y=mt+gh-(planned[i]*gh/100); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke(); ctx.setLineDash([]);
  ctx.strokeStyle='#00b894'; ctx.lineWidth=3; ctx.beginPath();
  for(let i=0;i<=11;i++){ const x=ml+(i*gw/11),y=mt+gh-(actual[i]*gh/100); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke();
  const ly=mt+10; ctx.fillStyle='#0066cc'; ctx.fillRect(ml+gw-200,ly,30,3); ctx.fillStyle='#6c757d'; ctx.textAlign='left'; ctx.font='12px Times New Roman'; ctx.fillText('Planificado',ml+gw-165,ly+4);
  ctx.fillStyle='#00b894'; ctx.fillRect(ml+gw-200,ly+20,30,3); ctx.fillStyle='#6c757d'; ctx.fillText('Real',ml+gw-165,ly+24);

  // Tooltip functionality
  let tooltip = null;
  function showTooltip(e, week, plannedPct, actualPct) {
    if (tooltip) tooltip.remove();
    const variance = actualPct - plannedPct;
    const status = variance > 0 ? 'Adelantado' : variance < 0 ? 'Retrasado' : 'En tiempo';
    const color = variance > 0 ? '#00b894' : variance < 0 ? '#ff6b6b' : '#ffd166';
    tooltip = document.createElement('div');
    tooltip.style.position = 'absolute';
    tooltip.style.left = e.pageX + 10 + 'px';
    tooltip.style.top = e.pageY - 10 + 'px';
    tooltip.style.background = 'rgba(0,0,0,0.8)';
    tooltip.style.color = 'white';
    tooltip.style.padding = '8px 12px';
    tooltip.style.borderRadius = '6px';
    tooltip.style.fontSize = '12px';
    tooltip.style.pointerEvents = 'none';
    tooltip.style.zIndex = '1000';
    tooltip.innerHTML = `
      <strong>Semana ${week}</strong><br>
      Planificado: ${plannedPct.toFixed(1)}%<br>
      Real: ${actualPct.toFixed(1)}%<br>
      <span style="color:${color}">${status}: ${Math.abs(variance).toFixed(1)}%</span>
    `;
    document.body.appendChild(tooltip);
  }

  function hideTooltip() {
    if (tooltip) {
      tooltip.remove();
      tooltip = null;
    }
  }

  c.addEventListener('mousemove', function(e) {
    const rect = c.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // Check if mouse is over chart area
    if (x >= ml && x <= ml + gw && y >= mt && y <= mt + gh) {
      const weekIndex = Math.round((x - ml) / gw * 11);
      if (weekIndex >= 0 && weekIndex <= 11) {
        showTooltip(e, weekIndex, planned[weekIndex], actual[weekIndex]);
      }
    } else {
      hideTooltip();
    }
  });

  c.addEventListener('mouseleave', hideTooltip);

  // Calculate advance/delay based on actual date
  const currentDate = state.currentDate ? new Date(state.currentDate + 'T00:00:00') : new Date();
  const startDate = state.startDate ? new Date(state.startDate + 'T00:00:00') : null;

  let calculatedWeek = cw; // Default to manual selection
  if (startDate) {
    const diffTime = currentDate.getTime() - startDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const calculatedWeekFromDate = Math.floor(diffDays / 7) + 1;
    calculatedWeek = Math.max(1, Math.min(11, calculatedWeekFromDate)); // Clamp between 1-11
  }

  const advanceDelayEl = document.getElementById('advanceDelayText');
  if(calculatedWeek > 0 && calculatedWeek <= 11){
    const plannedAtCurrent = planned[calculatedWeek];
    const actualAtCurrent = actual[calculatedWeek];
    const variance = actualAtCurrent - plannedAtCurrent;
    const status = variance > 0 ? 'Adelantado' : variance < 0 ? 'Retrasado' : 'En tiempo';
    const color = variance > 0 ? '#00b894' : variance < 0 ? '#ff6b6b' : '#ffd166';
    const text = `${status} por ${Math.abs(variance).toFixed(1)}% (Semana ${calculatedWeek} - Planificado: ${plannedAtCurrent.toFixed(1)}%, Real: ${actualAtCurrent.toFixed(1)}%)`;
    advanceDelayEl.textContent = text;
    advanceDelayEl.style.color = color;
    ctx.fillStyle=color; ctx.font='bold 14px Times New Roman'; ctx.textAlign='left';
    ctx.fillText(`${status}: ${Math.abs(variance).toFixed(1)}%`, ml+10, mt+30);
  } else {
    advanceDelayEl.textContent = 'Configura fecha de inicio y actual para ver el avance/retraso';
    advanceDelayEl.style.color = '#6c757d';
  }

  // Debug: Add console logs to verify calculation
  if(calculatedWeek > 0 && calculatedWeek <= 11){
    console.log('DEBUG - Calculated Week from date:', calculatedWeek);
    console.log('DEBUG - Manual Week selection:', cw);
    console.log('DEBUG - Planned at current:', planned[calculatedWeek]);
    console.log('DEBUG - Actual at current:', actual[calculatedWeek]);
    console.log('DEBUG - Variance:', actual[calculatedWeek] - planned[calculatedWeek]);
  }
}
// ====== Render tablas ======
function tr(act,objId){
  const saved=state[objId]?.[act.cod]??'';
  return `<tr>
    <td><b>${act.cod}</b></td><td>${act.desc}</td><td class="w-week">${act.semana}</td>
    <td class="weight">${act.peso}%</td>
    <td><input type="number" min="0" max="100" step="1" value="${saved}" data-obj="${objId}" data-cod="${act.cod}" aria-label="Avance ${act.cod}"></td>
    <td><div class="row-progress"><div class="mini"><span id="mini-${objId}-${act.cod}" style="width:${clamp(saved)}%"></span></div><small class="pct" id="txt-${objId}-${act.cod}">${clamp(saved)}%</small></div></td>
  </tr>`;
}
function render(){
  ['o1','o2','o3','o4'].forEach(id=>{
    const o = objetivos.find(x=>x.id===id);
    document.getElementById('tbody-'+id).innerHTML=o.actividades.map(a=>tr(a,id)).join('');
  });
  bindInputs(); recalcAll(); drawCurvaS();
}
function bindInputs(){
  document.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      inp.value=inp.value.replace(/[^0-9.]/g,''); const v=clamp(inp.value);
      const obj=inp.dataset.obj,cod=inp.dataset.cod; state[obj]=state[obj]||{}; state[obj][cod]=v;
      document.getElementById(`mini-${obj}-${cod}`).style.width=v+"%";
      document.getElementById(`txt-${obj}-${cod}`).textContent=v+"%";
      markTouched(); recalcAll(); drawCurvaS(); renderWeekPlanning(); saveNowMaybe();
    });
  });
}
// ====== Resumen ======
function avanceObjetivo(obj){
  const o=objetivos.find(x=>x.id===obj); let sum=0;
  o.actividades.forEach(a=>{ const av=clamp(state[obj]?.[a.cod]); sum+=av*(a.peso/100); });
  return +sum.toFixed(2);
}
function recalcAll(){
  const summary=document.getElementById('summary'); summary.innerHTML=''; let total=0;
  objetivos.forEach(o=>{
    const av=avanceObjetivo(o.id); const contrib=av*(o.pesoProyecto/100); total+=contrib;
    const el=document.createElement('div'); el.className='summary-item';
    el.innerHTML=`<div class="summary-head"><span><b>${o.nombre}</b></span><span class="pct">${av}%</span></div>
      <div class="bar"><span style="width:${av}%"></span></div>
      <div class="legend" style="margin-top:10px">
        <span class="pill">Peso en proyecto: <b>${o.pesoProyecto}%</b></span>
        <span class="pill">Contribución actual: <b>${contrib.toFixed(2)}%</b></span>
      </div>`;
    summary.appendChild(el);
  });
  document.getElementById('overallBar').style.width=total+'%';
  document.getElementById('overallPct').textContent=total.toFixed(1)+'%';
  document.getElementById('overallRing').style.setProperty('--pct', total+'%');
}
// ====== Botones locales ======
document.getElementById('save').addEventListener('click', ()=>{ persistLocal(); toast('Guardado en este navegador ✓','ok'); });
document.getElementById('reset').addEventListener('click', ()=>{
  if(confirm('¿Reiniciar todos los avances a 0%?')){
    Object.keys(state).forEach(k=>delete state[k]); localStorage.removeItem(key);
    render(); markTouched(); saveNowMaybe();
  }
});
document.getElementById('print')?.addEventListener('click', ()=>window.print());
document.getElementById('export')?.addEventListener('click', ()=>{
  const data = { objetivos, state, timestamp: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tablero-bioetanol-export.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Datos exportados como JSON','ok');
});
// ====== Sync JSONBin ======
const autosyncEl=document.getElementById('autosync');
const btnPull=document.getElementById('pull');
const btnPush=document.getElementById('push');
autosyncEl.checked=!!state.__autosync;
autosyncEl.addEventListener('change', ()=>{ state.__autosync=autosyncEl.checked; persistLocal();
  toast(state.__autosync?'Autosync activado':'Autosync desactivado','warn'); if(state.__autosync){ saveNowMaybe(true); } });
btnPull.addEventListener('click', async ()=>{ const ok=await pullFromCloud(true); if(ok) toast('Datos descargados desde la nube','ok'); });
btnPush.addEventListener('click', async ()=>{ const ok=await pushToCloud(true); if(ok) toast('Datos enviados a la nube','ok'); });
// Marca temporal y persistencia
function nowISO(){ return new Date().toISOString(); }
function markTouched(){ state.__updatedAt=nowISO(); }
function persistLocal(){ saveStateLocal(state); }
let saveTimer=null;
function saveNowMaybe(force=false){
  persistLocal(); if(!state.__autosync && !force) return;
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{ pushToCloud().catch(()=>{}); }, 600);
}
// JSONBin helpers
function headers(write=false){
  const h={'Content-Type':'application/json'};
  if(MASTER_KEY){ h['X-Master-Key']=MASTER_KEY; }
  if(write){ h['X-Bin-Versioning']=USE_VERSIONING ? 'true' : 'false'; }
  return h;
}
function payload(){ const {__autosync,__updatedAt,...rest}=state; return { data: rest, meta:{ updatedAt: state.__updatedAt || nowISO() } }; }
async function pullFromCloud(showErrors=false){
  try{
    const res=await fetch(API_URL+'/latest',{method:'GET',headers:headers(false)});
    if(!res.ok) throw new Error(`GET ${res.status}`);
    const json=await res.json(); const record=json.record||json;
    const cloudUpdated=record?.meta?.updatedAt||record?.__updatedAt||null;
    const localUpdated=state.__updatedAt||null;
    const cloudIsNewer=!localUpdated||(cloudUpdated&&cloudUpdated>localUpdated);
    if(cloudIsNewer){
      const keep={__autosync:state.__autosync}; Object.keys(state).forEach(k=>delete state[k]);
      const recovered=record?.data||record; Object.assign(state,recovered,{__autosync:keep.__autosync,__updatedAt:cloudUpdated||nowISO()});
      persistLocal(); render();
    }
    return true;
  }catch(err){
    if(showErrors) toast('Error al leer JSONBin: '+err.message,'err',4000); return false;
  }
}
async function pushToCloud(showErrors=false){
  if(!MASTER_KEY){ if(showErrors) toast('Falta X-Master-Key','err',5000); return false; }
  try{
    const body=JSON.stringify(payload());
    const res=await fetch(API_URL,{method:'PUT',headers:headers(true),body});
    if(!res.ok) throw new Error(`PUT ${res.status}`);
    state.__updatedAt=nowISO(); persistLocal(); return true;
  }catch(err){
    if(showErrors) toast('Error al escribir JSONBin: '+err.message,'err',4000); return false;
  }
}
// ====== Tema ======
function toggleTheme(){
  const body = document.body;
  const btn = document.getElementById('themeBtn');
  if(body.classList.contains('dark-theme')){
    body.classList.remove('dark-theme');
    btn.textContent = 'Tema Claro';
    state.theme = 'light';
  } else {
    body.classList.add('dark-theme');
    btn.textContent = 'Tema Oscuro';
    state.theme = 'dark';
  }
  persistLocal();
}
document.getElementById('themeBtn').addEventListener('click', toggleTheme);
if(state.theme === 'dark'){ document.body.classList.add('dark-theme'); document.getElementById('themeBtn').textContent = 'Tema Oscuro'; }

// ====== Tabs functionality ======
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// ====== Week planning view ======
function renderWeekPlanning(){
  const container = document.getElementById('weekSummary');
  const currentDate = state.currentDate ? new Date(state.currentDate + 'T00:00:00') : new Date();
  const startDate = state.startDate ? new Date(state.startDate + 'T00:00:00') : null;

  if (!startDate) {
    container.innerHTML = '<div class="card"><p>Configura la fecha de inicio para ver la planificación por semanas.</p></div>';
    return;
  }

  const diffTime = currentDate.getTime() - startDate.getTime();
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  const currentWeek = Math.max(1, Math.min(11, Math.floor(diffDays / 7) + 1));

  let html = '';

  for (let week = 1; week <= 11; week++) {
    const weekStart = addWeeks(startDate, week - 1);
    const weekEnd = addWeeks(startDate, week);
    weekEnd.setDate(weekEnd.getDate() - 1);

    let status = 'pending';
    let statusText = 'Pendiente';
    if (week < currentWeek) {
      status = 'completed';
      statusText = 'Completada';
    } else if (week === currentWeek) {
      status = 'current';
      statusText = 'Actual';
    }

    html += `
      <div class="week-card">
        <div class="week-header">
          <div class="week-title">Semana ${week}</div>
          <div class="week-status ${status}">${statusText}</div>
        </div>
        <div style="font-size:12px;color:#6c757d;margin-bottom:12px">
          ${formatDate(weekStart)} - ${formatDate(weekEnd)}
        </div>
        <ul class="task-list">
    `;

    objetivos.forEach(obj => {
      obj.actividades.forEach(act => {
        const ws = parseWeeks(act.semana);
        if (ws.start <= week && ws.end >= week) {
          const progress = clamp(state[obj.id]?.[act.cod] || 0);
          const isCompleted = progress >= 100;
          const isCurrent = week === currentWeek;
          const remaining = 100 - progress;

          html += `
            <li class="task-item">
              <div class="task-name">${act.cod}: ${act.desc}</div>
              <div class="task-objective">${obj.nombre}</div>
              <div class="task-weight">${act.peso}%</div>
              ${isCurrent ? `<div style="color:#0066cc;font-weight:600">${progress}% ${remaining > 0 ? `(Faltan ${remaining}%)` : ''}</div>` : ''}
            </li>
          `;
        }
      });
    });

    html += `
        </ul>
      </div>
    `;
  }

  container.innerHTML = html;

}

// ====== Configuration ======
function renderConfig(){
  const container = document.getElementById('configContainer');
  let html = '';

  objetivos.forEach((obj, objIndex) => {
    html += `
      <div class="objective-config" style="margin-bottom:24px;border:1px solid #dee2e6;padding:16px;border-radius:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <input type="text" value="${obj.nombre}" data-type="obj-name" data-obj="${obj.id}" style="font-weight:700;font-size:16px;border:1px solid #ced4da;padding:4px 8px;border-radius:4px">
          <div style="display:flex;gap:8px;align-items:center">
            <label>Peso proyecto: <input type="number" value="${obj.pesoProyecto}" data-type="obj-peso" data-obj="${obj.id}" min="0" max="100" style="width:60px"></label>
            <button class="remove-objective" data-obj="${obj.id}" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px">Eliminar</button>
          </div>
        </div>
        <div class="activities-config">
    `;

    obj.actividades.forEach((act, actIndex) => {
      html += `
        <div class="activity-config" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:#f8f9fa;border-radius:4px">
          <input type="text" value="${act.cod}" data-type="act-cod" data-obj="${obj.id}" data-act="${actIndex}" style="width:60px">
          <input type="text" value="${act.desc}" data-type="act-desc" data-obj="${obj.id}" data-act="${actIndex}" style="flex:1">
          <input type="text" value="${act.semana}" data-type="act-semana" data-obj="${obj.id}" data-act="${actIndex}" style="width:80px">
          <input type="number" value="${act.peso}" data-type="act-peso" data-obj="${obj.id}" data-act="${actIndex}" min="0" max="100" style="width:60px">
          <button class="remove-activity" data-obj="${obj.id}" data-act="${actIndex}" style="background:#dc3545;color:white;border:none;padding:4px 8px;border-radius:4px">X</button>
        </div>
      `;
    });

    html += `
        <button class="add-activity" data-obj="${obj.id}" style="margin-top:8px;background:#28a745;color:white;border:none;padding:6px 12px;border-radius:4px">+ Agregar Actividad</button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;

  // Bind config events
  container.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('input', updateConfig);
  });

  container.querySelectorAll('.remove-objective').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const objId = e.target.dataset.obj;
      objetivos = objetivos.filter(o => o.id !== objId);
      state.objetivos = objetivos;
      markTouched();
      render();
      renderConfig();
      saveNowMaybe();
    });
  });

  container.querySelectorAll('.remove-activity').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const objId = e.target.dataset.obj;
      const actIndex = parseInt(e.target.dataset.act);
      const obj = objetivos.find(o => o.id === objId);
      obj.actividades.splice(actIndex, 1);
      state.objetivos = objetivos;
      markTouched();
      render();
      renderConfig();
      saveNowMaybe();
    });
  });

  container.querySelectorAll('.add-activity').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const objId = e.target.dataset.obj;
      const obj = objetivos.find(o => o.id === objId);
      const nextCod = obj.actividades.length + 1;
      obj.actividades.push({
        cod: `${objId.slice(1)}.${nextCod}`,
        semana: '1',
        peso: 10,
        desc: 'Nueva actividad'
      });
      state.objetivos = objetivos;
      markTouched();
      render();
      renderConfig();
      saveNowMaybe();
    });
  });
}

function updateConfig(){
  objetivos.forEach(obj => {
    const objNameInput = document.querySelector(`input[data-type="obj-name"][data-obj="${obj.id}"]`);
    const objPesoInput = document.querySelector(`input[data-type="obj-peso"][data-obj="${obj.id}"]`);
    if (objNameInput) obj.nombre = objNameInput.value;
    if (objPesoInput) obj.pesoProyecto = parseInt(objPesoInput.value) || 0;

    obj.actividades.forEach((act, index) => {
      const codInput = document.querySelector(`input[data-type="act-cod"][data-obj="${obj.id}"][data-act="${index}"]`);
      const descInput = document.querySelector(`input[data-type="act-desc"][data-obj="${obj.id}"][data-act="${index}"]`);
      const semanaInput = document.querySelector(`input[data-type="act-semana"][data-obj="${obj.id}"][data-act="${index}"]`);
      const pesoInput = document.querySelector(`input[data-type="act-peso"][data-obj="${obj.id}"][data-act="${index}"]`);
      if (codInput) act.cod = codInput.value;
      if (descInput) act.desc = descInput.value;
      if (semanaInput) act.semana = semanaInput.value;
      if (pesoInput) act.peso = parseInt(pesoInput.value) || 0;
    });
  });
  state.objetivos = objetivos;
  markTouched();
  render();
  saveNowMaybe();
}

document.getElementById('addObjective').addEventListener('click', () => {
  const nextId = `o${objetivos.length + 1}`;
  objetivos.push({
    id: nextId,
    nombre: `Objetivo ${objetivos.length + 1}`,
    pesoProyecto: 10,
    actividades: [{
      cod: `${nextId.slice(1)}.1`,
      semana: '1',
      peso: 100,
      desc: 'Nueva actividad'
    }]
  });
  state.objetivos = objetivos;
  markTouched();
  render();
  renderConfig();
  saveNowMaybe();
});

// ====== init ======
function firstLoad(){ pullFromCloud(false).then(()=>{ render(); renderWeekPlanning(); renderConfig(); }).catch(()=>{ render(); renderWeekPlanning(); renderConfig(); }); }
initDatePicker(); firstLoad();
</script>
</body>
</html>
